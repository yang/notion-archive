# Web development

# npm tools

- patch-package

# Next Next.js

- Server-side data fetching will be coming in the future once Suspense stabilizes: [https://github.com/vercel/next.js/discussions/37136?sort=top#discussioncomment-2811618](https://github.com/vercel/next.js/discussions/37136?sort=top#discussioncomment-2811618)

# JS sandboxing

- node’s vm module is not secure
- [https://github.com/losfair/blueboat](https://github.com/losfair/blueboat)
    - [https://news.ycombinator.com/item?id=29321442](https://news.ycombinator.com/item?id=29321442)
- CF Workers [https://flareact.com/docs/comparison-to-nextjs](https://flareact.com/docs/comparison-to-nextjs)
- vm2 is based on vm’s and proxies. Very usable.
- isolated-vm: Lower level and harder to use. Requires you to write your own
- [https://chromium.googlesource.com/chromium/src/+/master/third_party/blink/renderer/bindings/core/v8/V8BindingDesign.md](https://chromium.googlesource.com/chromium/src/+/master/third_party/blink/renderer/bindings/core/v8/V8BindingDesign.md)

# Rust

- rustup is the bootstrapper
- wasm-pack for building to wasm

# Remix

- Data loading done server side
    - useLoaderData() can be called from any component.
- FS based routing
    - app/routes/
- Everything is hydrated by default, but you can manually opt out
    - No partial hydratio
- Questions
    - Does this use RSC?
        - Supposedly the loader is using RSC, but everything is basically SSR
    - How does it determine what’s client vs server component?
        - No need, it’s just SSR
    - What if I add state to my useDataLoader-invoking route?
- [https://dev.to/dabit3/a-first-look-at-remix-run-449a](https://dev.to/dabit3/a-first-look-at-remix-run-449a)
- [https://dev.to/dabit3/how-is-remix-different-from-next-js-4jd1](https://dev.to/dabit3/how-is-remix-different-from-next-js-4jd1)

# React libraries

- [https://github.com/pmndrs/suspend-react](https://github.com/pmndrs/suspend-react)

# JS libraries

- [https://github.com/epoberezkin/fast-deep-equal](https://github.com/epoberezkin/fast-deep-equal)
- [https://github.com/developit/unfetch/tree/master/packages/isomorphic-unfetch](https://github.com/developit/unfetch/tree/master/packages/isomorphic-unfetch)

# Storybook alternatives

- [https://reactpreview.com](https://reactpreview.com)
- 

# Framer Motion

- AnimatePresence handles exit on any descendants: [CSB](https://codesandbox.io/s/animatepresence-handles-exit-on-any-descendants-5i355)
    - However, only descendants of immediate children of AnimatePresence that have been unmounted! It won’t just detect arbitrary removals anywhere deep in the tree
    - “Note: The custom component being removed from the DOM must still be a direct descendant of AnimatePresence for the exit animation(s) it contains to trigger.” ([docs](https://www.framer.com/docs/animate-presence/##animating-custom-components))
- **No way to achieve AnimateSharedLayout exit animations that don’t take up layout space, a la onExit in react-flip-toolkit**: [CSB](https://codesandbox.io/s/cannot-add-exit-transitions-on-animatesharedlayout-for-instance-to-achieve-cross-fading-5h1wm?file=/src/App.tsx)
    - In other words, no way to achieve a cross-faded page transition / transition between two different DOM trees!
    - AnimatePresence makes both before and after rendered in-layout, as long as the before-tree is still animating its exit
    - Try removing the AnimatePresence—that just causes the `exit` to not work at all
    - exitBeforeEnter simply causes all exit animations to run first; you can fade-out then fade-in, but can’t cross-fade
    - If dimensions are known / you can replicate the dimensions in `position:absolute`, then you can use `useIsPresent` and toggle `position:absolute` for the exit ([CSB](https://codesandbox.io/s/framer-motion-list-transitions-forked-nqd2r?file=/src/App.js), [YT](https://www.youtube.com/watch?v=uamucl_ANuA)—sets `width:100%`)
- AnimateSharedLayout type=crossfade requires blending both before and after. To have a ‘before’, it needs AnimatePresence to ensure the element still is rendered during the blend, and (as always) the AnimatePresence itself must not be unmounted. [CSB](https://codesandbox.io/s/animatesharedlayout-crossfade-does-not-handle-non-simultaneously-rendered-items-forked-filjc?file=/src/App.tsx)
- As documented, if you have multiple elements with the same layoutId, it will choose to show only the later-rendered one, and make the original invisible: [CSB](https://codesandbox.io/s/animatesharedlayout-makes-the-original-disappear-if-you-have-multiple-items-with-the-same-layoutid-l4fqp)

# react-flip-toolkit

- Flipped actually uses portals to mount elements as siblings to keep them around for longer than the Flipped itself is alive for (the Flipped itself is unmounted; no need for an AnimatePresence)

# Next.js

- getInitialProps: called on server but also on client on client-side transitions
    - No support for static / cached (ISR), unlike getStaticProps
    - Shipped down to the client, unlike getServerSideProps
    - Had to be isomorphic and ran on client-side transitions, unlike getS*Props
- getStaticProps, getServerSideProps: always evaluated on server
    - Not on _app/_document because don’t want to force all pages to be SSR (if they could be static) ([source](https://github.com/vercel/next.js/discussions/10874#discussioncomment-1085))
- _app.getInitialProps
    - Expected to call `App.getInitialProps(appContext)` (which calls page getInitialProps) and merge into returned props
        - But this does NOT call Page.getStaticProps/getServerSideProps! And there’s no way to get at those functions from the Page module.
        - Runs BEFORE Page.getStaticProps/getServerSideProps
    - Includes an `AppTree` special object that was made to let Apollo `getDataFromTree`  work, so you could do `<AppTree {…appContext.appProps}>`
    - Has a `appContext.Component`, unlike for _document
    - Disables Automatic Static Optimization in pages without Static Generation
    - If page being navigated has getServerSideProps, then getInitialProps will run on server ([source](https://nextjs.org/docs/api-reference/data-fetching/getInitialProps))
- _document.getInitialProps
    - Always server side only! Not called on client-side transitions
    - Does not have a `ctx.Component`
    - Does NOT disable Automatic Static Optimization
    - ctx.req is undefined for prerendered pages
    - Like _app, has AppTree, but doesn’t include Page.getStaticProps/getServerSideProps, and no way to get at this
    - `Document.getInitialProps(ctx)` actually performs the app/page renders; this doesn’t happen in Document’s own render.
- Sequencing:
    
    ```jsx
    App.getInitialProps
      Page.getInitialProps
    Page.getServerSideProps or Page.getStaticProps
    Document.getInitialProps
      App.render
        Page.render
    Document.render
    ```
    
- Both getInitialProps and getStaticProps/getServerSideProps together in same page is an error
- getStaticProps is run as SSR if preview mode is set

# Unsorted

[https://markodenic.com/css-tips/](https://markodenic.com/css-tips/)

# 2D graphics

- [Benchmark](https://news.ycombinator.com/item?id=23083730): PixiJS > two.js

# Binary data

- Use `formdata-node` instead of `form-data` (not standard-compliant, [source](https://github.com/node-fetch/node-fetch#advanced-usage))
- For Blob, use `import {Blob} from 'node:buffer'` in Node>=16 ([source](https://stackoverflow.com/questions/14653349/node-js-cant-create-blobs))
- Blob to ArrayBuffer: `await blob.arraybuffer()` (or FileReader readAsArrayBuffer)
- ArrayBuffer to Blob: `new Blob([new Uint8Array(data)])`
- ArrayBuffers vs Blobs ([source](https://stackoverflow.com/questions/11821096/what-is-the-difference-between-an-arraybuffer-and-a-blob))
    - ArrayBuffers: mutable, in memory
    - Blobs: immutable, can be in external memory
- TypedArrays are interfaces over ArrayBuffers ([source](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray))
    - Get the underlying ArrayBuffer: `arrayBuffer.buffer`
- Node `Buffer` is just a subclass of `Uint8Array`, and node accepts UInt8Array wherever Buffer is accepted ([source](https://nodejs.org/api/buffer.html))
- Utilities and conversion one-liners: [https://github.com/feross/buffer](https://github.com/feross/buffer)

# MIME and Content-Type

- TODO Is there a difference between the two?
- Detect file types with [https://www.npmjs.com/package/file-type](https://www.npmjs.com/package/file-type) or [https://github.com/deepakjois/node-detect-content-type](https://github.com/deepakjois/node-detect-content-type)
- Map extensions to types with [https://www.npmjs.com/package/mime-types](https://www.npmjs.com/package/mime-types)

# HTTP

- [Great talk](https://www.youtube.com/watch?v=TNlcoYLIGFk&list=WL&index=1) on various HTTP headers

# fetch

When using `fetch`, you must pass `credentials` for cookies to be sent, but I still don’t know how to access `set-cookie` headers!

# React server data fetching

- Server side Suspense is not available yet
- Apollo getDataFromTree is [not recommended](https://github.com/vercel/next.js/pull/21426#issuecomment-765324962) because it [incurs full re-renders](https://github.com/vercel/next.js/discussions/10946#discussioncomment-1206)
- react-ssr-prepass doesn’t just “call renderToStaticMarkup repeatedly” and is an actually custom renderer that does suspend execution ([source](https://formidable.com/open-source/react-ssr-prepass/)) - [Dan says “not ideal/idiomatic”](https://twitter.com/dan_abramov/status/1342265408016035840) but not sure if referring specifically to this solution

# Typescript sum types

- There are two approaches: value-first (a la io-ts, where the type is inferred from a value description of the type) and type-first
- [https://github.com/practical-fp/union-types:](https://github.com/practical-fp/union-types:) type-first
- [https://github.com/paarthenon/variant:](https://github.com/paarthenon/variant:) supports both type-first and value-first
- Discussion of the above: [https://www.reddit.com/r/typescript/comments/mq2a0q/practicalfpuniontypes_a_typescript_library_for/](https://www.reddit.com/r/typescript/comments/mq2a0q/practicalfpuniontypes_a_typescript_library_for/)
- [https://github.com/pelotom/unionize:](https://github.com/pelotom/unionize:) value-first
- [https://github.com/pfgray/ts-adt:](https://github.com/pfgray/ts-adt:) most bare-bones
- [https://github.com/twop/ts-union](https://github.com/twop/ts-union)
- [https://github.com/Kinrany/ts-sum-types:](https://github.com/Kinrany/ts-sum-types:) archived

# React Server Components

- Demo
    - Doesn’t send pre-rendered HTML. Client fetches Server Component output stream.
    - Nothing stops you from calling SC from CC, but it’ll crash when executing server code/modules.
- Terminology
    - SSR: What happens today. SSR+hydration is a “magic trick” like iOS/Android app switchers loading a cached screenshot before it becomes real/interactive.
        - SSR is like a simulated client side rendering environment that just runs on the server.
    - Server components output stream: This is some non-HTML raw data format.
        - Can either stream this directly to browser (as in the RSC demo), or SSR can interpret this into HTML first
- You cannot call CC → SC. But you can do `<CC><SC/></CC>`.
- CC not rendered on “server” at all. But SSR = simulated client-side
- AFAIK there is no isomorphic component that can use side effects.
- Fizz is the new HTML-streaming server in React 18. Flight is the RSC-streaming server.
    - “We're currently working on a new implementation of the streaming server renderer which has some new interesting features but particularly that's how we plan to integrate the data stream from Server Components so that you will be able to server render into HTML together with Server Components.” ([source](https://www.swyx.io/react-server-components-demo/))
    - Fizz does not have anything for handling server components yet.
- [https://www.swyx.io/react-server-components-demo/](https://www.swyx.io/react-server-components-demo/)

## Open issues

- Need to first implement new streaming SSR (React 18)
- Need to figure out side effects of server components (e.g. CSS imports)
- Bundle strategy. Currently generating tiny bundles at every client component encountered. Need to at least analyze the server graph for this. (But not actually emit them)
    - Sebastian interested in bundling the server anyway into a service worker for development.

## My questions

- Will there still be a way to emit content from server with “lightweight” CC behavior around it? Such as a blog feed with accordioned posts—must those all be CCs and thus not able to hydrate on the client?
    - You can use `<CC><SC/></CC>`
- Can you still get isomorphic components as you can in SSR today?
    - Yes, SSR is what RSC streams to
- Is RSC output stream (→ HTML stream) to be added into Fizz?
    - I think Flight is actually going to pipe to Fizz
- How is versioning/deployment handled? Route stability/prop schema evolution?

# Next.js partial hydration

- [https://medium.com/@luke_schmuke/how-we-achieved-the-best-web-performance-with-partial-hydration-20fab9c808d5](https://medium.com/@luke_schmuke/how-we-achieved-the-best-web-performance-with-partial-hydration-20fab9c808d5)
    - Uses Preact
    - Call sites mark client components: `const HydratedTwitterFeed = withHydration(TwitterFeed); … <HydratedTwitterFeed/>`

# Next.js

- Stores hydration prop data in `NEXT_DATA`.

# Typescript

- Stages
    - Scan
    - Parse
    - Bind: resolving references
    - Transform: strip out TS
        - before: before transform (typescript)
        - after: after transform (javascript) - can still make transformations at this point
        - afterDeclarations: after declarations are prepared
    - Emit
- Transformer:
    - function that takes AST & returns altered AST (or you’re just linting)

# Ideas for React starter kit

- Blitz? Next? CRA?
- Cypress
- Analytics
- Stricter TS
- no-floating-promises etc.
- prettier
- pre-commit
- github actions
- esbuild/sucrase
- Validation
- react-query

# Data “stores” to watch

- Postgraphile
- Hasura
- Prisma
- TypeGraphQL
- Firebase
- [https://supabase.io/](https://supabase.io/)

# React data fetching

- Client libraries
    - react-query
    - react-swr
    - Apollo
    - Relay
    - [https://github.com/FormidableLabs/urql](https://github.com/FormidableLabs/urql) ([comparison](https://formidable.com/open-source/urql/docs/comparison/))
- Considerations
    - Caching
    - Invalidation
    - Sharing
    - Optimistic updates
- GraphQL considerations
    - (Main one) **Deep caching** at the level of individual entities inside a response
    - **Normalization** of a graph of objects
    - **Data masking** so each component receives exactly the set of data it declared, and no more - Relay supports this
    - **Automatic composition** so that you don’t have to manually remember to compose fragments into their parent queries.
    - **Parameterized fragments**. Apollo has [only experimental support for this](https://stackoverflow.com/questions/55415125/how-to-pass-parameter-to-graphql-fragment). urql has no fragments.
    - **Selective refetching** so that you only refetch the fragments that are invalidated

# Relay

Docs are not great.

Invalidating specific records ([docs](https://relay.dev/docs/guided-tour/reusing-cached-data/staleness-of-data/#invalidating-specific-data-in-the-store)):

```
function updater(store) {
  const user = store.get('<id>');
  if (user != null) {
    user.invalidateRecord();
  }
}
...
useSubscribeToInvalidationState([user.id], ...)

```

# Free localhost tunnels

- cloudflared
- ssh -R 80:localhost:8080 localhost.run
    - Great, no fuss
- localtunnel
    - Requires click-through
- ngrok
    - Requires signup, but stable name

# Cross-package development

E.g., if I want to make changes to react-web, how do I test those changes from a downstream project?

If I use yarn link, then webpack (on the downstream project) emits a bundle that has two Reacts in it (one from ./node_modules, another from ...../@plasmicapp/react-web/node_modules), despite react being a peerDep.

One "solution" I've found is to replace the dependency in the downstream project with `file:...` (being careful not to check this in) and repeatedly deleting node_modules/@plasmicapp/react-web and reinstalling. Then, when the upstream change is done - publish a new release of it, replace `file:...` with the new version, yarn install, and commit.

But turns out yalc can save the day! Simply `yalc publish` on upstream, and `yalc link @plasmicapp/react-web` on downstream.

There's also yarn workspaces - does that avoid the peerDep issue?

# Module analysis

- things I have found myself wondering:
    - what are the biggest contributors to bundle size?
    - how is module X getting included? want to show the import chains from the “roots”. ultimately want to prevent it from being included.
    - what are the circular dependencies?
    - why is module X getting imported before module Y?
- tools:
    - webpack-bundle-analyzer works but has some heuristics inaccuracies analyzing concatenated modules, which webpack produces ([one](https://stackoverflow.com/questions/48851554/webpack-bundle-analyzer-n-modules), [two](https://github.com/webpack-contrib/webpack-bundle-analyzer/issues/188))
    - source-map-explorer works on the generated outputs quite well and seems more accurate
    - dependency-cruiser and madge both can make .dot files, but these can be overwhelming
    - dependency-cruiser supports validation rules, such as import bans
    - whybundled works only on webpack stats json output
    - CRA doesn’t support webpack stats json output anymore (removed `--stats` in v3)
    - haven’t been able to get intellij dependencies analysis to work
    - [survey of more webpack tools](https://survivejs.com/webpack/optimizing/build-analysis/)

# esbuild

Lacks CSS support:

- [https://github.com/evanw/esbuild/issues/20](https://github.com/evanw/esbuild/issues/20)
- [https://github.com/evanw/esbuild/issues/418](https://github.com/evanw/esbuild/issues/418)
- [https://github.com/evanw/esbuild/issues/465](https://github.com/evanw/esbuild/issues/465)

Lacks code splitting:

- [https://github.com/evanw/esbuild/pull/468](https://github.com/evanw/esbuild/pull/468)
- [https://github.com/evanw/esbuild/issues/399](https://github.com/evanw/esbuild/issues/399)

# vite

- Wasn’t able to get it to work

# snowpack

- Uses esbuild as per-file builder
- Wasn’t able to get it to work

Has multi entrypoints:

- [https://github.com/snowpackjs/create-snowpack-app/issues/74](https://github.com/snowpackjs/create-snowpack-app/issues/74)

Some dynamic imports don’t work:

- [https://github.com/snowpackjs/snowpack/discussions/1201](https://github.com/snowpackjs/snowpack/discussions/1201)

Can’t import monaco:

- [https://github.com/snowpackjs/snowpack/discussions/1201](https://github.com/snowpackjs/snowpack/discussions/1201)

Lacks sucrase:

- [https://github.com/snowpackjs/create-snowpack-app/issues/122](https://github.com/snowpackjs/create-snowpack-app/issues/122)

# Dynamic script tags

- Won’t run when added using innerHTML.
- document.write() is locked after page loads
- Must use `appendChild(document.createElement(``'``script``'``))`

# HTTPS localhost

Quick and dirty: use devcert-cli/mkcert and stunnel.

CAVEAT: stunnel doesn’t provide X-Forwarded-For headers!

Create webserver.conf:

```
pid = /tmp/wab-stunnel.pid

[https]
accept = 3002
connect = 3003
cert = localhost-combined.pem

```

Run:

```
npx devcert-cli generate localhost
# or: mkcert localhost
cat localhost-key.pem localhost.pem > localhost-combined.pem
stunnel webserver.conf

# test
curl --insecure https://localhost:3002

```

# Favicons

[https://evilmartians.com/chronicles/how-to-favicon-in-2021-six-files-that-fit-most-needs](https://evilmartians.com/chronicles/how-to-favicon-in-2021-six-files-that-fit-most-needs)

# FullStory

- You can search sessions for clicks on elements that contain exact text or match a CSS selector.  Such as an error notification dismissal button.
- Watched Elements are in Beta and let you

# HTML

- [https://www.twilio.com/blog/html-attributes-two-factor-authentication-autocomplete](https://www.twilio.com/blog/html-attributes-two-factor-authentication-autocomplete)

# React useMethods

- Cons
    - Methods can’t return anything but void.

# Cypress

- Core concepts
    - Doesn’t use promises because of retry-ability
    - There is a queue of commands that are executed.  Each method in a chain, and each new chain, is run sequentially, so often you don’t need to worry about the asynchronicity.  The only time you need to use .then is to READ data (if you don’t want to use `.as()`)..
    - Types of methods
        - Assertions: should, …
        - Commands: everything else.  These further either retry (get) or don’t retry (click)
    - Types of methods by where they come in the chain
        - Parent: visit, get, request, exec, route
        - Child: click, trigger, find, should, as
        - Dual: contains, screenshot, scrollTo, wait
    - Retryability
        - Retries only the last command in a chain before the failing assertion, not the entire chain.
        - And only retries commands that query the document, not click etc.
        - Retries a command if either it fails to find anything, or if the subsequent assertions fail.

# Tooling Wishlist

- Static checking
    - Require spawn() around unused promises
    - Check React contexts
    - Prohibit using constructor.name
    - Prohibit certain methods, e.g. always use strictFromPairs over L.fromPairs
- Dev
    - Zero downtime reloads
    - Replay debugging
- CI/CD
    - Zero downtime reloads
    - FullStory cross-referenced with Sentry

# React Native

## Styling

- No selectors, cascading stylesheets—only simple inline styles ([docs](https://facebook.github.io/react-native/docs/stylesheet.html))
    - Styled Components: doesn’t support any nested rules/selectors ([issue](https://github.com/styled-components/styled-components/issues/1812))
- Inheritance limited to text subtrees—recommend using components (with context) and expecting isolation ([source](https://medium.com/@fullsour/style-inheritance-of-react-native-eca1c974f02b), [SO](https://stackoverflow.com/questions/41307988/simplest-way-to-cascade-styles-in-react-native))
- Use StyleSheets for greater perf ([docs](https://facebook.github.io/react-native/docs/0.7/stylesheet))

# CSS Modules

- No way to import classes from another module and refer to them as part of your own selector; latest was proposed `:external()` [https://github.com/css-modules/css-modules/issues/147](https://github.com/css-modules/css-modules/issues/147)

# Styled Components

- You can build and “nest-generate” (a la Sass) complex selectors with `&`, and refer to other styled components for their generated classes.  You can also nest media queries (unlike in plain CSS?):
    
    ```jsx
    styled.div`
      flex:none;
      ...${Link}:hover & {
        fill:rebeccapurple;
      }
      @media (max-width: 700px) {
        background: palevioletred;
      }
    `
    ```
    
- BEM can be done with helpers like [https://github.com/Decisiv/styled-components-modifiers](https://github.com/Decisiv/styled-components-modifiers) or [https://github.com/ezcater/styled-component-variant](https://github.com/ezcater/styled-component-variant)
    
    ```jsx
    const MODIFIER_CONFIG = {
      // The functions receive the props of the component as the only argument.
      // Here, we destructure the theme from the argument for use within the modifier styling.
      disabled: ({ theme }) => `...`,
      success: ({ theme }) => `...`, 
      loading: () => `...`,
    }
    
    const Button = styled.button`
      font-size: 24px;
      padding: 16px;
      ${applyStyleModifiers(MODIFIER_CONFIG)};
    `;
    
    <Button modifiers={['large', isLoading && 'loading']}>...</Button>
    ```
    
- For static variants, you can also use the built-in `extend` function:
    
    ```jsx
    const ButtonExtendV2 = styled.button`...`
    export const ButtonExtendV2Primary = ButtonExtendV2.extend`...`
    export const ButtonExtendV2Success = ButtonExtendV2.extend`...`
    ```
    

# Random APIs

## REST

- [https://jsonplaceholder.typicode.com/](https://jsonplaceholder.typicode.com/)
- [https://randomuser.me/](https://randomuser.me/)
- Customizable:
    - [https://www.json-generator.com/](https://www.json-generator.com/) (no auth needed)
    - [https://randomapi.com/](https://randomapi.com/)
    - [https://www.mockaroo.com/](https://www.mockaroo.com/)

## Images

- [https://fillmurray.com/200/300](https://fillmurray.com/200/300)
- [https://uifaces.co/](https://uifaces.co/)
- [https://source.unsplash.com/random](https://source.unsplash.com/random)

## GraphQL

- [https://fakerql.com/](https://fakerql.com/)
    
    ```jsx
    curl 'https://fakerql.com/graphql' -H 'Content-Type: application/json' -H 'Accept: application/json' --data-binary '{"query":"{\n  allPosts(count: 5) {\n    id\n    createdAt\n    body\n    author {\n      firstName\n      lastName\n      email\n      avatar\n    }\n  }\n}"}'https://link.resilio.com/#f=Game.of.Thrones.S01.1080p.WEB-DL.DD5.1.H.264-SA89%5Brartv%5D&sz=0&t=1&s=EUSQAGVQDMG63TLN4TY4PUZHRCQFGWTU&i=CZTZQWLO4Y4CPT6RVC5ZLXSNIMUNQG6M6&e=1557695723&v=2.6&a=2
    ```
    
- [https://gql-placeholder.herokuapp.com/playground](https://gql-placeholder.herokuapp.com/playground) (no dates on posts, no avatars on users)

# Monaco

- typescriptDefaults.addExtraLib() affects global typescript language service, and does affect existing editor instances
- Implementing full editor: [https://blog.expo.io/building-a-code-editor-with-monaco-f84b3a06deaf](https://blog.expo.io/building-a-code-editor-with-monaco-f84b3a06deaf)
    - Implementing tabs: [https://github.com/Microsoft/monaco-editor/issues/604#issuecomment-344214706](https://github.com/Microsoft/monaco-editor/issues/604#issuecomment-344214706)
- editor.setHiddenAreas() works but is undocumented API
    - Relevant threads:
        - [https://github.com/Microsoft/monaco-editor/issues/45](https://github.com/Microsoft/monaco-editor/issues/45)
        - [https://stackoverflow.com/questions/46982692/monaco-editor-how-to-make-some-areas-readonly](https://stackoverflow.com/questions/46982692/monaco-editor-how-to-make-some-areas-readonly)
        - [https://github.com/Microsoft/monaco-editor/issues/664](https://github.com/Microsoft/monaco-editor/issues/664)
        - [https://github.com/Microsoft/monaco-editor/issues/953](https://github.com/Microsoft/monaco-editor/issues/953)
        - [https://github.com/Microsoft/monaco-editor/issues/874](https://github.com/Microsoft/monaco-editor/issues/874)
- TSX support
    - [https://stackoverflow.com/a/55055782/43118](https://stackoverflow.com/a/55055782/43118)
    - [https://github.com/cancerberoSgx/jsx-alone/blob/master/jsx-explorer/HOWTO_JSX_MONACO.md](https://github.com/cancerberoSgx/jsx-alone/blob/master/jsx-explorer/HOWTO_JSX_MONACO.md)
- Custom build of monaco-typescript/monaco-editor
    - Why: [https://github.com/microsoft/monaco-editor/issues/1439](https://github.com/microsoft/monaco-editor/issues/1439)
    - [https://github.com/dojo/web-editor/wiki/Create-a-build-of-monaco-typescript-and-monaco-editor](https://github.com/dojo/web-editor/wiki/Create-a-build-of-monaco-typescript-and-monaco-editor)
    - [https://github.com/microsoft/monaco-editor/blob/master/CONTRIBUTING.md](https://github.com/microsoft/monaco-editor/blob/master/CONTRIBUTING.md)
        - Note simpleserver
        - Note the git folders must be siblings for you to run a package (like monaco-typescript) from source
- If using addExtraLib, can use `tsc` `--``declaration` to generate .d.ts files from .ts.  So with your existing expressions, you can generate an ambient .d.ts.

# Browsers

## Performance

- Performance can be greatly affected by opening DevTools.  E.g., was working on using SystemJS to load a bunch of modules—12s with DevTools open, 4s with profiling running (must be pausing some functionality elsewhere in DevTools), 1s with it closed!
- Also, use a fresh profile, not one with all your extensions running.

## Network

- Max concurrent connections in Chrome
    - HTTP/1.1: 6 per hostname, 10 total ([source 1](http://blog.olamisan.com/max-parallel-http-connections-in-a-browser), [source 2](https://stackoverflow.com/questions/985431/max-parallel-http-connections-in-a-browser))
    - HTTP/2: 1 TCP connection per domain; with ~100 streams in Firefox by default; recommended <100; server can also specify limit ([source 1](https://stackoverflow.com/questions/36835972/does-the-per-host-connection-limit-is-raised-with-http-2), [source 2](https://stackoverflow.com/questions/39759054/how-many-concurrent-requests-should-we-multiplex-in-http-2))

# Sass

- `@import` `'``foo.css``'` just emits an `@import(foo.css)` into the CSS file; if you want build-time inclusion, drop the `.css`! ([source](https://stackoverflow.com/a/30279590/43118))

# Web Caching

## HTTP Caching

- Very confusing names!
- `Cache-Control: must-revalidate, max-age: 31536000`
    - ‘Cache it, and you can use it without server validation for a year
- `Cache-Control: no-cache, max-age: 31536000`
    - Cache it, and you can use it WITH server validation for a year
- [Source talk](https://www.youtube.com/watch?v=vAgKZoGIvqs)

## Preload

- Cache is private to the page; this is not some shared cache among all pages

## General

- Order of cache resolution: preload, then cache-control, then HTTP2 push cache

# DX Wishlist

- Access modules at runtime
- Faster build
- MST is closest, but it has issues with TS, and unclear story with async rendering
- Immutable with mutable, a la mobx-state-tree
- Unification/integration with remote data management, a la apollo-link-state
- Reactive programming framework that has React’s semantics of reusing parts of a graph data structure by using keys on lightweight handles (in React’s case, the graph is the tree of components, and the lightweight handles are React Elements)

# VueX

- Strict mode enforces all changes to happen within mutations
- Actions are functions that invoke mutations but which can be asynchronous.  The separation between mutations and actions is what allows VueX to keep using `async` rather than use MobX’s flow-based approach.

# General State Management

- Cached selectors are equivalent to computed states

## Future Directions

- Redux is not the future
    - [https://twitter.com/ryanflorence/status/1057010447432454146?lang=en](https://twitter.com/ryanflorence/status/1057010447432454146?lang=en)
    - [https://twitter.com/acdlite/status/1024852895814930432](https://twitter.com/acdlite/status/1024852895814930432)
    - [https://twitter.com/sebmarkbage/status/1032684851063705600?lang=en](https://twitter.com/sebmarkbage/status/1032684851063705600?lang=en)
- MobX, Redux, and other mutable stores are not the future, but Immer is
    - [https://twitter.com/sebmarkbage/status/1032684851063705600?lang=en](https://twitter.com/sebmarkbage/status/1032684851063705600?lang=en)
- Mutable global stores outside of React are the problem
    - [https://mobile.twitter.com/acdlite/status/1056990425406332928](https://mobile.twitter.com/acdlite/status/1056990425406332928)
- Functional, not class, components are the future, because they can have multiple states at once
    - [https://twitter.com/sebmarkbage/status/1084540252667109377](https://twitter.com/sebmarkbage/status/1084540252667109377)
    - [https://twitter.com/sebmarkbage/status/1084539728743956481](https://twitter.com/sebmarkbage/status/1084539728743956481)
- Local state over global state
    - [https://mobile.twitter.com/acdlite/status/1045362245507506176?lang=en](https://mobile.twitter.com/acdlite/status/1045362245507506176?lang=en) - but HOW should components subscribe? The only popular platform for this is MobX, but I doubt that’s what he’s referring to…

## Performance Challenge

- Drag-selection
    - Want 60fps (<16.6ms refreshes)
    - Many connected components
    - Only a few low down in the tree that should be updated
    - Much derived state
    - Thick intermediate derived state - but only part of it changed

## Derived State Challenge

- I want a form-like component of controls.
    - Let’s say we’re making a CAD tool, and it’s for displaying and setting the size constraints of an object.
- Let’s say it has a few input boxes for numbers.
- **I don’t want the object’s size to actually change until I’m “done” editing an input box** (i.e., I blur or hit enter, and not after every keystroke).
    - Hence there must be some temporary “draft” state that diverges from the “true” size of the object, until some submit event.
- I’m going to have this component all over the place.  **A controlled component would require I manage all this state myself, repeatedly.**  I don’t want to have to provide this controlled draft state boilerplate everywhere.  I’d like to refactor it out.
- **The size can be updated elsewhere without going through this set of controls**, e.g. user directly drags to resize the object in the canvas, or perhaps there is real-time collaboration and another user is resizing this object (i.e. no explicit UI events cause the change).  This is a common requirement for uncontrolled components, except…
- **I don’t want to reset the state of this form and its controls whenever values change.**  Things like input box focus should be maintained across changes (and recall changes can originate externally).  **So, don’t want to simply attach a** `**key**`**.**
- Slightly more complex requirement I’m ignoring for now: if the user is in the middle of typing, I don’t want to change that input box on them either, even if new values have come in.
- With the controlled approach, in the higher component that owns the state, it would be owning both the true size and the draft size.  When the draft size changes, it knows what new values to send to the component of controls (without fully resetting its state with a key change).
    - It would still need to do the work of knowing when to reset the draft size (e.g. when external changes are coming in).  In general, there always needs to be a way for the higher component to determine/communicate whether to reset the draft size.
    - This logic would be nice to refactor out into the component itself to avoid needing it everywhere.
    - There needs to be a way for the higher component to communicate to the component whether it wants to force its new values through or not.  Something similar to a key, but without the full state reset semantics.
    - So, we can provide a surrogate key `resetKey`, and have the component check for changes in this to determine whether to reset its values.
- I also don’t want a dumb set of inputs with defaultValues.  Examples:
    - Entering one number may influence the others.
    - Entering an invalid number will cause it.
- TODO flesh out further…

## Immutability vs mutability

- Immutability vs mutable observables: mutability can shortcut various unnecessary invalidations.  If you change one small part of the state tree that’s far down, with immutable data structures you need to bubble changes all the way up, triggering re-renders (and re-selects) on those parts up the chain.  E.g., with normalized data, if you update a Post, immutability causes all “queries” over the full array of Posts to be invalidated.
- It’s easier to navigate mutable state tree with full references rather than immutable sub-trees.  You can always pass the full immutable tree, but that means any update will cause all components to re-evaluate their selectors.
- Normalized immutable data structures have lots of identifier references, which are harder to strongly type.
- Immutable structures are nicer to interactively debug, since you can freely navigate the structures, and won’t trip the subscription mechanisms just by the act of inspecting.
- Immutable structures have stricter guarantees about when/where they can change.

## Properties vs Values

- MobX tracks changes to props; Redux “tracks” changes to values
- For MobX, this means you should **deref props late**.
    - Slow: `<X name={obj.name}/>`—outer component will refresh along with inner component when name changes.
    - Fast: `<X name={obj}/>`—outer component will not refresh along with inner component when name changes.
    - Never will MobX refresh X if another field of obj changes.
- For Redux, this means you should **access values early.**
    - Slow: `<X name={obj}/>`—X will refresh whenever any part of `obj` changes.
    - Fast: `<X name={obj.name}/>`—X will only refresh if the name changes.
    - Note: outer component *always* refreshes.  This is the logarithmic tax of immutability.
- So, it’s easier to get performance out of MobX than Redux.  MobX is already starting where Redux ends:
    
    
    |  | .name changes | another field changes |
    | --- | --- | --- |
    | Redux slow | all inners + outer refresh | all inners + outer refresh (assuming all inners are passed obj the same way as it’s passed to X) |
    | Redux fast | inner + outer refresh | outer refreshes |
    | MobX slow (note: same as Redux fast!) | inner + outer refresh | outer refreshes |
    | MobX fast | inner refreshes | outer refreshes |
- The more fine-grained the values to Redux, the better.  So, it tends to be more verbose, if you have a lot of different datums a component depends on.  With MobX, it’s sufficient to just pass the common parent(s) of these datums to get the same/better performance.// Redux
<X a={x.a} b={x.b} c={x.c} .../>
// MobX
<X x={x}/>

## Performance

- 12/2017: [https://medium.freecodecamp.org/a-real-world-comparison-of-front-end-frameworks-with-benchmarks-e1cb62fd526c](https://medium.freecodecamp.org/a-real-world-comparison-of-front-end-frameworks-with-benchmarks-e1cb62fd526c)
- [https://github.com/krausest/js-framework-benchmark](https://github.com/krausest/js-framework-benchmark) ([results](https://krausest.github.io/js-framework-benchmark/current.html))
- [Redux perf links](https://github.com/markerikson/react-redux-links/blob/master/react-performance.md)
- Great benchmark of stock ticker app comparing angular, redux, and mob x [https://medium.freecodecamp.org/measuring-performance-gains-angularjs-to-react-with-redux-or-mobx-fb221517455](https://medium.freecodecamp.org/measuring-performance-gains-angularjs-to-react-with-redux-or-mobx-fb221517455)

# Redux

## Overview

- Any time the store changes, all connected components must be re-evaluated.  This re-evaluation can be optimized with selectors/memoization, such that the wrapped dumb (presentational) component only updates if anything relevant has changed.
    - connectAdvanced() will let you apply more selective listening/updating ([issue](https://github.com/reduxjs/react-redux/issues/269)).
- connect() has a factory mode (perhaps this is now in connectAdvanced()), which lets you return a mapStateToProps function (for some reason these are called “fabric functions”).  It can read (close over) initialState/initialProps, and the returned function can ignore ownProps (so only refreshes if state changes / is independent of the later props).  This can be handy if the props that are used for tapping into state never change.
    - This can be seen in action in Abramov’s PR to the [pixel-paint perf demo](https://hackernoon.com/an-artificial-example-where-mobx-really-shines-and-redux-is-not-really-suited-for-it-1a58313c0c70).
    - Also broken down in [High Performance Redux](https://somebody32.github.io/high-performance-redux/).
    - This may be obsolete and an optimization that is now baked in as of v5? ([thread](https://twitter.com/somebody32/status/765126536118800384?lang=en))
- v5 and lower used direct subscriptions for connected components.  v6 switched to new context API, partially due to trying to play nicely with Concurrent React, and also due to avoiding having to do own update-ordering (should update components top-down).  But context API was slower, probably due to React’s implementation walking the full tree rather than navigating a shortlist of components. ([source](https://github.com/reduxjs/react-redux/issues/1177))
    - v7 is reverting to direct subscriptions.

# MobX

- Strict mode enforces all changes to happen within actions
- Actions can be `async`, but to support strict mode, changes must still be wrapped in actions, meaning the parts of your async code that make changes must be individually wrapped in `runInAction` .  Or, use MobX’s `flow()` for this to happen automatically.  Flows can also be canceled.

## Resolved Questions

- What are the pitfalls / places where Redux/immutable is better?
    - Cloning efficiency
    - Concurrency
- Do reactions fire if values are equal?
    - No it does compare values, and you can use custom comparators
- Do derived computations get batched or get computed synchronously when dependencies change?
    - Synchronous ([source](https://mobx.js.org/intro/concepts.html)), but you can batch with `transaction` ([source](https://mobx.js.org/refguide/transaction.html))

## Open Questions

- Does DevTools’ read-only evaluation work on MobX?
- If I update one element of an array, how does MobX know not to re-render the other items?
- How do you signal that nothing has changed in a transformation?
- What’s the difference vs RVal?
- Can MobX help with React hooks invalidations (e.g. stale callbacks)?

# MobX State Tree

- You can reference across things serialized separately using references/identifiers
- No type-safe IDs, but you don’t really need it since usually you use actual object instances where IDs are expected (and MST denormalizes things in the end).
- Use classy-mst if you want to write actions as ES6 class methods
- React integration is using MobX observables, not immutable snapshots
- Pros/value props
    - Immutability via a mutable interface, which is nice for deeply nested structures
    - Automatic invalidation, either via immutability or observables (not sure which)
    - Simple import/export to JSON snapshots
    - Stores normalized, but interact as if denormalized (get/set object instances instead of IDs)
    - Actions that can be intercepted and serialized (TODO understand arguments treatment)
    - Actions binding is handled by MST such that you don’t have to bind them yourself (as with normal instance methods—this makes it easier to pass around method references without worrying about `this` due to JS semantics)
    - Supports discriminated unions
- Cons
    - Typescript type checking not great, missing some problems like array fields not being required for some reason
    - **😞**  Recursive types require duplicating declarations as Typescript types (see [one](https://github.com/mobxjs/mobx-state-tree/issues/417) [two](https://github.com/mobxjs/mobx-state-tree/issues/658#issuecomment-386663673) [three](https://github.com/mobxjs/mobx-state-tree/issues/943))
    - Can’t reference self.otherActions(), need to write as `function`s.
    - Slower Typescript completion/live intelligence
    - More cryptic type errors (allegedly from elsewhere)
    - Members are not `readonly` to Typescript (outside of actions)
    - 😞 No decentralized derived state.
    - [TS issues roundup](https://github.com/mobxjs/mobx-state-tree/issues/1201)
- Hypothesized cons
    - 😞 Slow performance, still? ([issue](https://github.com/mobxjs/mobx-state-tree/issues/440))
    - Harder to refactor since these are not native types
    - Slightly clunky inheritance—maybe not bad though if we embrace tagged unions.

## Challenges

- Supporting different trees, and providing transparent references across different trees. ([issue](https://github.com/mobxjs/mobx-state-tree/issues/1202))
- Supporting local keys for reconciliation (a la React), rather than global IDs (much harder)

## Resolved Questions

See [sandbox](https://gitlab.com/yang/sandbox/tree/master/ts-mst) for exploration.

- How efficient is it to merge in a snapshot that has only changed slightly?  (E.g. if I want to use some immutable functions on my state, or if I want to use lodash, etc.)
    - MST recurses down snapshot into anything that is not Object.is-equal.
- Do maps efficiently and selectively invalidate by key?  (E.g. two components each access different key, one key changes, does just one component invalidate?)
    - Yes
- Can you have free floating computed values (views)?  How do you “extend” the tree with things that are not computed views and also you don’t want to be part of the tree / should be owned by a component?
    - Can, but without transparent references.  [Issue](https://github.com/mobxjs/mobx-state-tree/issues/1202)
- How do you “fork” a whole tree where only a small part low down is changed? (Can they structurally share internals, or—more likely—a whole MobX tree needs to be created?)
    - Must clone() the whole thing and then modify it.  You can always clone() just a small part of the tree, but you won’t get the rest of the state as a result.
- How to create a memoized callback?
    - Actions are already stable.  Not sure what else this question was getting at.
- Is it possible to use this to help with invalidating hooks (e.g. useEffect, useCallback)?
    - Iffy.  [Issue](https://github.com/mobxjs/mobx/issues/1923#issuecomment-470184940)
- Does changing a state tree leaf fire ancestors (since the immutable backing tree must have changed)?  Is setting a sub-tree to some snapshot able to efficiently bail out with initial shallow comparison?
    - Ancestors change in snapshot tree but not mobx tree.
    - Yes, MobX bails out if reference-equal (potentially missing mutations you snuck in).
- What happens when you set some reference to point to an instance that wasn’t already in the tree?  Or try to deserialize something with a reference to such an instance?  Etc.
    - It tries to prevent you from inserting broken references, but you can always get a tree with broken references (even just by cloning a sub-tree that has references pointing outside the sub-tree).  Touching that reference field at all will then raise errors.
- Does it play well with RHL?
    - I think so.

## Performance

- My own performance measurements added to [this issue](https://github.com/mobxjs/mobx-state-tree/issues/440)
- From 6/2017: [https://github.com/amir-arad/mst-benchmark](https://github.com/amir-arad/mst-benchmark)

# Npm

- Scopes are just namespaces, but they can be used for private packages and for in direction can be mapped to an external repository registry.
- Scopes can be mapped to another registry besides the primary npm registry. This mapping is configured locally to a client.
- All private packages must be long to a scoped.
- All collaborators on a private package must be at least paid npm user accounts.
- bit makes interesting use of npm Scopes to publish users components. They have their own registry.

# Viewports

- [Guide](https://developer.mozilla.org/en-US/docs/Mozilla/Mobile/Viewport_meta_tag)
- There’s a layout viewport and a visual viewport
- Different mobile browsers have different default viewport sizes (unless a viewport size is specified) - i.e. different “virtual desktop screen widths”
- Desktop browsers ignore the meta tag - no way to resize the viewport there

# Email addresses

- G Suite doesn’t ignore dots in email addresses as gmail does—has ramifications if you e.g. pre-provision user accounts by email address and expect a Google Sign-In to match it ([source](https://support.google.com/a/answer/33386?hl=en))

# Firestore

## Rules

- Cannot have multiple get()s?  See [https://stackoverflow.com/questions/53138544/firestore-security-rules-not-working-when-using-multiple-levels-of-get-calls](https://stackoverflow.com/questions/53138544/firestore-security-rules-not-working-when-using-multiple-levels-of-get-calls)
- **Cannot have duplicate rules, like two “allow write:” lines?** (source: experiments)
- `resource` refers to the ultimately fetched object (source: experiments)
- Intermediate objects do not recursively have their ACLs checked for read permissions (source: experiments)
- **Cannot query objects by fields using anything like where conditions**.  Can only access documents by their path.  So you must be able to keep constructing a chain of path references starting from the user end and/or the retrieved document end.  (And you can only generate a single chain of path references; can’t map arrays of them.)
- **To create users before they ever authenticate**, you can create email/password user, and ensure that the setting for “**One account per email**” is enabled, so that if someone then signs in with e.g. Gooogle Signin (source: experiments)

**Examples**

Say you have a task app:

```
Task { assigneeRefs: User[] }
User {} // not keyed by UID (useful for when you have invites, or any user objects created before the users first authenticate - note you can also )
UserFwd keyed by UID { userRef: User }

```

The above should work.  But not:

```
User { authUid: string }
Task { assigneeRefs: User[] }
// no UserFwds

```

since you cannot array-map to check every assignee's authUid!

Say you have a task app with users keyed by user IDs.  The following should all be possible:

```
User keyed by UID { groupRef: Group }
Group {}
Task { groupRef: Group }

// Here, you can check that a constructed user path is in the userRefs array.  This is the deepest you can go with arrays, treating it like an array of strings.  You can't get() the arrays to do a deeper check or anything.
User keyed by UID {}
Group { userRefs: User[] }
Task { groupRef: Group }

// Similarly, here you can check that the accessed task path is in taskRefs.
User keyed by UID { groupRef: Group }
Group { taskRefs: Task[] }
Task {}

```

The above should work.  But not:

```
User keyed by UID {}
Group { userRefs: User[]; taskRefs: Task[]; }
Task {}

```

# Ant

## Components

- Popover and Trigger: they must take a trigger prop, one of click|hover|etc., and can’t be not-triggered-by-anything or otherwise fully controlled.  Even if you set visible to true/false, it still responds to trigger (but **also** responds to changes in visible).  This is useful though, since you may still want to dismiss the popover when clicking outside, which you’d get with trigger=click (it’ll just always show as well).

## Theming

- You can import styles….
    - Manually and individually, e.g.:
    import Button from 'antd/lib/button';
    import 'antd/lib/button/style'; // or antd/lib/button/style/css for css format file
    - (Recommended) Automatically when importing any component by using Ant’s horribly named `babel-plugin-import`, which still can do code pruning:
    import { Button } from 'antd';
    - Wholesale, which doesn’t allow for code pruning—e.g.:
    // either:
    import 'antd/dist/antd.css';
    import 'antd/dist/antd.less';
- If you want to override the theme, you can use [this approach](https://medium.com/@GeoffMiller/how-to-customize-ant-design-with-react-webpack-the-missing-guide-c6430f2db10f) (also [here](https://ant.design/docs/react/use-with-create-react-app#Customize-Theme) and [here](https://ant.design/docs/react/customize-theme#Customize-in-webpack)), but to make changes you have to restart webpack dev server.
- Live changes can be made easily with the crude approach of creating a `./antd-overrides.less` with:
@import 'antd/dist/antd.less';
@component-background: #fcfcfc;
...

# Origins and execution contexts

SOP ensures isolation, so different origins are well suited to running in different processes.

But what about two tabs/windows/iframes from the same origin?

If they have a reference to each other, i.e. they were created using window.open() or iframe, then they actually have synchronous access to each other and share:

- event loop
- heap
- code

E.g., I can write a function in the parent, assign it to a global variable (in `window.foo` or `someIframe.contentDocument.foo` or something), and the child can access it (`parent.window.foo`  or `document.foo`, respectively) and execute it.

If that function references things like window/document, they’re still the parent's though (as expected).  They won’t magically re-bind to the child’s.

# React Hot Loader

- It may only be partially working - edits to some files trigger full reload, while edits to others properly hot reload.  The problem may be: **Webpack checks that the only import chain from the root module (e.g. index.tsx) to the edited module goes through the hot() module**, or else full reload**.**
    - You can just ensure that the hot module is super high up in your application architecture!
    - Say you edit a file E.  Webpack hot loader crawls the reverse dependency graph, finding D that imports E, recurses, finds C imports D, etc.
    - It’s looking for a module that either…
        - **is the module that exported the hot() component—in this case, it does not recurse into its dependents**.  And in the good case, this is the last remaining upstream dependent it will check.
        - **Or, the root module (e.g. index.tsx) (or really, the “0” module), which triggers a full reload.**  It’s as if you edited a file that was “outside” the subgraph “under” the outermost hot component (there really was no shielded subgraph).
    - The relevant code is in `getAffectedStuff()`.

# Functional Programming

## Utility libraries

Immutable.js

[https://ramdajs.com/](https://ramdajs.com/)

[https://folktale.origamitower.com/docs/v2.3.0/overview/](https://folktale.origamitower.com/docs/v2.3.0/overview/)

[https://sanctuary.js.org/](https://sanctuary.js.org/)

[https://github.com/fluture-js/Fluture](https://github.com/fluture-js/Fluture)

rxjs

[[https://github.com/kolodny/immutability-helper](https://github.com/kolodny/immutability-helper)](https://github.com/kolodny/immutability-helper)

```
const newData = update(myData, {
  x: {y: {z: {$set: 7}}},
  a: {b: {$push: [9]}}
});

```

[[https://github.com/rtfeldman/seamless-immutable](https://github.com/rtfeldman/seamless-immutable)](https://github.com/rtfeldman/seamless-immutable): Immutable JS data structures which are backwards-compatible with normal Arrays and Objects.

```
var array = Immutable(["totally", "immutable", {hammer: "Can’t Touch This"}]);

array[1] = "I'm going to mutate you!"
array[1] // "immutable"

array[2].hammer = "hm, surely I can mutate this nested object..."
array[2].hammer // "Can’t Touch This"

for (var index in array) { console.log(array[index]); }
// "totally"
// "immutable"
// { hammer: 'Can’t Touch This' }

JSON.stringify(array) // '["totally","immutable",{"hammer":"Can’t Touch This"}]'

```

# React Pitfalls

## General

- When you update a component, the updates don’t automatically propagate down to its children if the children are passed in, e.g. `({children}) => <div>{children}</div>` (assuming the children didn’t change).  I think this is because of the more general rule that if the JSX element is unchanged, then updates are not necessarily attempted.
- When you addEventListener() in a componentDidMount (say, pointerdown), it *usually but won’t always* fire after the same event type in your React components (onPointerDown).  It depends entirely on whether React has ever before had to set up that event handler!  If it hasn’t (this is the first time you’ve used onPointerDown in your app), then React’s will come second.  But if you unmount and then remount the component, the componentDidMount listener will come second.  So to ensure consistent ordering, make sure you’ve already used onPointerDown somewhere before.  This matters in particular to modals or anything else that may need to dismiss some UI if you click outside, but not if you click inside.

## Hooks

- useEffect that calls setState must specify keys or else infinite loop
- setState should generally use the functional form to ensure you have the freshest state
- Closures in useMemo, useCallback, useEffect, etc. can become stale if you don’t specify the right keys—[common mistake](https://mobile.twitter.com/dan_abramov/status/1098898584626495488)
    - Can be confusing to think about what’s safe vs stale in these closures. Example—is this safe? (Should reset count after some timeout.) Turns out it is—resetCount is captured from the initial pass, so its count is 0.
        
        ```jsx
        function Counter() {
          const [count, setCount] = useState(0);
          let timeoutIdRef = React.useRef<number|undefined>(undefined);
          const resetCount = () => {
            setCount(count);
            window.clearTimeout(timeoutIdRef.current);
            timeoutIdRef.current = undefined;
          };
          const onClick = useCallback(() => {
            setCount(count + 1);
            if (timeoutIdRef.current === undefined) {
              timeoutIdRef.current = window.setTimeout(resetCount, 1000);
            }
          }, [count]);
          return <Button onClick={onClick}>Count: {count}</Button>;
        }
        ```
        
- See also good examples from [Dan’s blog on `useInterval`](https://overreacted.io/making-setinterval-declarative-with-react-hooks/) (TODO cleanup)
- `useEffect()` deps and `useMemo()` deps differ (TODO cleanup)
    - Both `useEffect()` and `useMemo()`/`useCallback()` have similar signatures — a function and a list of deps — but the deps help you control different things.
    - The deps to `useMemo()`/`useCallback()` controls when a new instance of something is returned.  When you’re thinking about the deps to these hooks, you’re worried that your handler will be using stale values from a stale closure.
    - The deps to `useEffect()` control when an effect is run.  You’re not worried that your first effect function is getting stale closure (unless you’ve wrapped it in `useCallback()`).  That effect function is always getting a fresh closure; you are just trying to make sure it fires when it’s supposed to fire.
    - For both of these, a good rule of thumb is to pass into deps is “the list of local variable values that the argument function references”.  This gets enforced by `exhaustive-deps` lint rule, though I think that rule makes more sense for `useMemo()`/`useCallback()` than for `useEffect()` due to the difference above.

# React Questions

- If ReactDOM.findDOMNode() is getting deprecated, then how should one get a reference to this.props.children?  There are many utility wrapper components that want to do something with the children they’re given, e.g. measuring their rendered DOM node’s dimensions or otherwise doing something with the DOM node.
- How does one “fork” a ref - not just forward it but access it themselves as well?
- What is the best way to compose events (and other props)?  E.g., when you have HOCs or something like Downshift, you inject multiple props into the same DOM node.
- TODO fill out this question, related to prev question.  What is the best approach to composing decorations that must reach into children?
    - `<Tooltip>…</Tooltip>` won’t work if … is a non-DOM component, unless the component forwards DOM props like onMouseEnter, so you can’t stack e.g.: `<Tooltip><WithContextMenu><div>…` unless `WithContextMenu` forwards props (in which case, all decorators should forward props)
    - Should it be `<Tooltip><WithContextMenu><div>` or should `WithContextMenu` produce its own div?  (Maybe former.)
    - But what if it’s `<Tooltip><MyDropdown>` (where MyDropdown is not a decorator)?  Should all components be accepting all div props?  Doesn’t seem right either.
    - So maybe it should be `<Tooltip><div><MyDropdown>`?  And `<Tooltip><div><WithContextMenu><div>`?
    - **ALSO:** it’s not just about forwarding props, but also getting refs!  What if both Tooltip and WithContextMenu need a ref to the div element?

# ReactDOM

- label’s `for` must be `htmlFor`

# React Misc

- Why are portals good?
    - Consider alternative of implementing your own by setting some global “popup” state ([Abramov’s SO post](https://stackoverflow.com/questions/35623656/how-can-i-display-a-modal-dialog-in-redux-that-performs-asynchronous-actions/35641680))
        - When the portal parent receives new props, it can’t simply pass them down to some portal child; instead you need some other communication mechanism, e.g. setState() on that remote component, or setting top-level state.  This can all require at least two render cycles!
        - Similarly, communication upward must be explicitly passed back somehow; you can’t rely on bubbling up the React stack, which is convenient.
- Lifecycle
    - shouldComponentUpdate never called in PureComponents (doesn’t override)

# React Performance

## Hooks

- `onToggleYellow = useCallback(() => setYellow(!isYellow), [isYellow])` ([source](https://github.com/ryardley/hooks-perf-issues/pull/2))
    - Frequently invalidating the callback.
    - Instead, can use alt form of setYellow `setYellow(isYellow => !isYellow)`
    - This means you don’t need to regenerate new isCallback
    - This is more similar to how reducers work, which they take an explicit argument representing the current state to be transformed (rather than closing over it from the closure).
- `useCallback` that depends on (closes over) an often changing value would normally need to be regenerated so a new closure can close over the latest value. ([source](https://reactjs.org/docs/hooks-faq.html#how-to-read-an-often-changing-value-from-usecallback))
    - Alternative approach: mutably store the latest dependency value (that you would normally specify as invalidation key) into a ref, and use a never-changing callback that reads from that ref.
    - Unsafe with Concurrent React, recommend avoid passing callbacks down by using contexts.
- `useReducer`'s dispatch never changes, unlike setState callbacks, so it results in fewer invalidations.
- `useReducer` actually runs the reducer **at render time**, so you in fact have access to fresh props/other state from the closure ([source](https://github.com/ryardley/hooks-perf-issues/pull/3), [thread](https://mobile.twitter.com/dan_abramov/status/1102010979611746304)).
    - They avoid the need to generate fresh callbacks.  To reiterate: you can freely close over fresh props/other state without invalidating, since the reducer runs at render time.

## Tools

- [https://github.com/maicki/why-did-you-update](https://github.com/maicki/why-did-you-update)
    - Doesn’t work with custom componentDidUpdate ([source](https://github.com/maicki/why-did-you-update/issues/17))
        
        ![image (3).png](Web%20development%20768a80680473459b963814b7f4a9c716/image_(3).png)
        
- [https://github.com/MerlinLabs/should-component-update-dev](https://github.com/MerlinLabs/should-component-update-dev) no longer works
- [https://github.com/MalucoMarinero/react-wastage-monitor](https://github.com/MalucoMarinero/react-wastage-monitor) does this still work?
- [react-addons-perf](https://reactjs.org/docs/perf.html) doesn’t work with React 16, most useful part is [printWasted](https://reactjs.org/docs/perf.html#printwasted)
- Break up components / make them generic
- Pure components
    - [https://news.ycombinator.com/item?id=14418576](https://news.ycombinator.com/item?id=14418576)

# React “Challenges”

Some of these are really just references to content elsewhere in this doc

- State management
- Portal context vs event tree
- Portal composition (modals, dropdowns, etc.) - TODO flesh this out
- How to compose props and props that are event callbacks?
    - How to compose decorator elements? `<Tooltip><WithCtxMenu><button/>…`

# Downshift Component

- When using controlled props to manage the state, need to make sure you’re covering all the relevant state, because Downshift will continue setting its own internal state without regard to your props.  So, for instance, controlling selectedItem will not ensure the inputValue reflects that selectedItem; when selecting an item, the inputValue will just be set to that item’s text representation rather than whatever selectedItem you are specifying.
    - Consider using
    - If you still want to use controlled props, consider using a
- Downshift uses `null` as an item value.  For instance, itemToString may be passed `null`, and by default this renders the empty string, and selectedItem can be `null`.  But you can’t actually have `null` as a menu item; the internal onSelect handler for `null` values simply results in a no-op and ignores that selection altogether.

# React Components

## Overlays

- The requirement: overlay system with stackability/nestability, and with keepOpenDoms style “safe zones”
- keepOpenDoms is useful for things like:
    - Autocomplete with safe input box as well as dropdown menu (clicking outside both will close the menu)
    - Webflow style sidebar controls, where you (e.g.) select a background layer from a layer list, and a details panel pops up, but the original layer in the list is safe to click (but clicking outside both will close the details panel)
    - WAB style DimControl where selecting a Side causes a DimSpinner to appear elsewhere (the “modal”), and clicking anywhere in the doc deselects / causes the modal to disappear, but you’re free to click on other Sides to add to the selection
        - [Ultimately, this just uses SidebarPopup for its onCancel event, since SidebarPopup attaches a doc-wide listener]
- Overlay stacking: important for nested overlays because e.g. clicking on an inner modal should not close outer modal, even though the inner modal is not contained in the outer modal’s DOM.
- Bad solutions:
    - Use React portals to render the overlay to document.body.  Attach a doc-wide mousedown listener.  When this is triggered, check to see if it’s a click on the DOM subtree of either the overlay, the overlay “button”, or a keepOpenDom safe zone.
        - Problem: stacking/nesting broken.  If we have an overlay 2 atop overlay 1, then clicks on overlay 2 should not dismiss anything, yet overlay 2 is not in the DOM subtree of any of overlay 1’s safe zones.
    - My approach before react portals, where I had a showPopup() function that pushed a render function onto a global stack of layers, that a top-level App component renders.  The App component also installs a doc-wide mousedown listener, which dismisses modals up through the desired one.  Each layer could also specify some keepOpenDoms that, when clicked, behaves the same as clicking somewhere within that layer.
        - Checked boxes: modals, nested modals, keepOpenDoms (unrestricted—see point further down), dismissing through a layer.
        - Problem: had to explicitly trigger re-renders/updated render function/props, but this is a localized problem.
        - Problem: had to explicitly transfer any relevant context, which is a composability problem (had to know what all descendants require).
        - Overall, not a bad solution.
- Solution:
    - Stacking comes naturally to React portals because of the event bubbling up the component tree.  Use React click handler to notify the global click handler to ignore this click, in order to ignore clicks to that component sub-tree.
        - Idea for if you have some overlay component that doesn’t work like this: you’ll need to use it as a controlled component, then find a way to detect the click first and ignore the subsequent onHide/onCancel.
- Note that keepOpenDoms feature is limited to DOM subtree checks and not component subtree checks, since you can’t check if an event was on some arbitrary component subtree, without actually instrumenting that part of the component tree.  (Maybe there’s an alternate API design to explore there, since you’re technically also needing to “instrument” the DOM subtree by attaching a ref—you can’t just do nothing, unless you’re relying on something yucky like query selectors.)
    - A consequence of this is that keepOpenDoms **must specify things within the current portal’s (the current overlay’s) physical DOM subtree**.
    - Basically, any click, including keepOpenDoms clicks, *will* trigger all doc-wide click listeners.  Only the respective layer that specified that keepOpenDom will know to ignore it, but the other overlays aren’t aware of it.  So the keepOpenDom element must be within the safe component sub-tree.
    - TODO explain this better!
    - Alternative idea to native support for keepOpenDoms: can you just check the event.target within onHide (BS overlays) / onCancel (Ant modals) / etc.?
        - Yes!  This actually works fine.  So it may not even worth baking in support for keepOpenDoms, unless it’s a real convenience.
        - Note that you’re limited to the same restrictions as keepOpenDoms—DOM elements must be within this portal’s (this overlay’s) physical DOM subtree.  See note below about keepOpenDoms restrictions.
- Survey
    - react-overlays
        - Modal always has a mask, clicks on which trigger dismissal—so much easier problem
        - Overlay and Dropdown use a RootCloseWrapper utility component, which does not support stacking/nesting.
            - a global event (“click” by default) listener just checks DOM subtree; component subtree not involved, so no nesting/stacking
    - react-modal
        - Same as above, modal always has a mask
    - rc-trigger
        - optional mask
        - this follows the described Solution
            - a div (in PopupInner) that contains the popup content ultimately receives an onMouseDown that calls onPopupMouseDown()
            - onPopupMouseDown() sets a flag indicating to ignore the next click; a next-tick timeout resets this flag
            - a global click listener calls onDocumentClick(), which checks this flag to determine whether to close
- Dropdowns with Autocomplete have extra requirements:
    - Close the menu on blur, but not close it when clicked in menu or in input
    - react-select
        - Attaches document touchstart event handlers that close menu if outside
        - But how to determine what’s “outside”?  Renders menu not via portal but a position:absolute;z-index:1 child, so it’s trivial (menu is actual DOM child)
        - Side note: doesn’t want to add an isOpen property ([source](https://github.com/JedWatson/react-select/issues/1989))
    - react-autocomplete
        - Injects onTouchStart, onMouseEnter, onMouseLeave into menu, which simply set a flag saying to ignore the next blur event (onMouseLeave resets this)
        - Renders menu also inline, similar to react-select
    - z-index rendering can be clipped and is somewhat limited (can’t pop menu upward if dropdown is too low, for instance)
    - ant / rc-select / rc-trigger ([example](https://react-component.github.io/select/examples/combobox.html))
        - Renders via portal
        - Uses onMouseDown -> preventDefault on whole dropdown menu, so clicking in it doesn’t trigger blur at all…
            - But how does this work in the face of focusable elements inside the menus?
    - WAB
        - Rendered via custom popups system.
        - Sets onMouseDown on menu, which sets a flag that, when inside input.onBlur, causes immediate re-focus on input—this changes I-beam location though

# React Portals

- Portal features:
    - Propagates events up.  TODO brainstorm more cases where this is useful.  The only one that comes to mind at the moment is when you want to detect inside vs outside clicks for something like a Select dropdown.
    - Propagates context down
- Event propagation can cause problems ([issue](https://github.com/facebook/react/issues/11387))Select =
button
...
SlotContent // rather than createPortal
Menu
    - When you have a Modal, dropdown menu, etc., you don’t typically don’t want clicks, mouseenter, etc. to bubble up to the parent.
    - At the same time, it *is* helpful to have events bubble up past the portal boundary.  TODO does it need to only
    - Example:
        
        ```jsx
        Tooltip // internally, uses onMouseEnter to trigger tooltip.
          div
            label
            div
              Select // internally, uses createPortal to create the dropdown.
                Option...
        ```
        
        - In this case, Select still needs clicks propagated across portal boundary so that it can correctly manage the show/hide logic (determine when a click is landing inside vs outside the select + its menu), but we *don’t* want the Modal etc. to be receiving its clicks.
    - Bad solutions:
        - Explicitly break apart the Select into multiple components, so that you can wrap the Tooltip around just the Button part.  This is annoying for ease of composition, since you need to decide where the SelectMenu should be rendered.  It also means the SelectMenu won’t get the context destined for the SelectButton.
            
            ```jsx
            SelectProvider
              Tooltip
                div
                  label
                  div
                    SelectButton
                      Option...
              SelectMenu
            ```
            
        - Add a createPortal()-like utility that stops events.  I.e. a createPortal() that wraps its contents in an Absorber (see below).  The problem is that you really do want event propagation at least somewhat past the portal boundary.  Also this completely doesn’t work for mouseenter, mouseleave.
        - Wrap Select in an Absorber component that just stops all event propagation.  Simple and blunt.  But this breaks event bubbling for Select button itself.  E.g. if you want Tooltip to appear when hovering over the Select button.
        - Have a Slot/SlotContent system like what sebmarkbage proposed.  However, so long as events and context need to share the same tree, this won’t work if you still want context but just route events up the DOM (or post-portal) tree.  Also, hurts compose-ability since you need to decide where the slot goes, and know that there is no higher-level location where they’re more appropriate (in this way it’s similar to the SelectProvider solution above)
            
            ```jsx
            Tooltip
              div
                label
                div
                  Select
                    Option...
            Slot // sibling of Tooltip
            
            Select =
              button
                ...
              SlotContent // rather than createPortal
                Menu
            ```
            
    - Solutions:
        - Explicitly control the state of both the tooltip and the select.  Wire up Select onVisibleChange to update state that shows the dropdown menu but suppresses the tooltip.  Verbose.
        - Have Select onVisibleChange update a global or higher-level state (perhaps this dispatcher injected via Context), and have Tooltips observe this state.  Similar to the explicit control approach above, but more scalable (to both deeper trees and more use sites).
            - However, having strict layers also precludes having things in the bottom layer still work.  I.e., you can’t localize such that only that particular Tooltip is disabled, for that particular Select’s dropdown menu, and still have the Tooltip for the Select button, and for all other places where there’s a Tooltip.
        - Have the event handlers in Tooltip ignore just this sub-tree.

# React Types

- ReactElement: has .type that is a ReactType
- ReactNode is ReactElement or ReactText
- ReactType is actual type: string, ComponentClass, StatelessComponent (stateless functional component)
- ComponentType, ComponentClass TODO

# Cross-cutting questions

- Why does jest see undefined when importing directly from antd/lib/icon but not import {Icon} from antd?

# Typescript

## Usage

- Usage: `tsc` by itself or `tsc -p DIR` - don’t use `tsc FILE` since that will ignore any tsconfig.json

## Compiler options

- Always enable `esModuleInterop`, see [this great write-up](https://www.typescriptlang.org/docs/handbook/release-notes/typescript-2-7.html)
- Probably should disable `allowJs` which causes problems (see [issue](https://github.com/Microsoft/TypeScript/issues/15230), and also sandbox/ts-jquery-data)

## Modules

- You typically just want `import foo from` `'``foo``'` or `import {stuff} from` `'``foo``'` and don’t need `import * as foo from 'foo'` or `import foo = require(``'``foo``'``)`
- (Some background) Ways to export things (TS / CommonJS):
    - `export function foo…` / `exports.foo = …`
    - `export default 0` / `exports.default = …`
    - `export =` / `module.exports = ...` → legacy instructions say to use `import =`
- `esModuleInterop` is recommended default by TS and CRA
    - If the module is a whole-module export, as in it has `module.exports = …` (or equivalently `export = …`), then it allows you to avoid needing `import classNames = …` and instead use `import classNames from` `'``classnames``'`
        - NOTE: You cannot use `import * as classNames from` `'``classnames``'` anymore, you must use `import classNames from` `'``classnames``'`, because the ES standard prohibits `*` imports from being anything other than a namespace, i.e. TS will enforce it to not be a callable type.  Note that tooling may still try to insert these, though.
        - Mostly these are outdated typings or legacy libraries.
    - If the module has just `export function readFile`  or `exports.readFile = …`, i.e. it just exports a namespace, then `import fs from` `'``fs``'` will be the same as `import * as fs from 'fs'` (you can use either)
    - If the module has an `export default` (the new standard instead of doing `module.exports`/`export =`), then `import classNames from` `'``classnames``'` will import that instead
- Merely including a .js file (like setupProxy.js) while `--isolatedModules` is enabled can raise obscure namespace error ([issue](https://github.com/Microsoft/TypeScript/issues/15230), [issue](https://github.com/facebook/create-react-app/issues/5587))
    - Sometimes you need to actually try importing this file as a module first.  Unclear when it actually arises.

## Tips for greater strictness

The following practices have caught many more bugs for me.  Some have tooling automation but others do not.

- Strict template literals that ensure all interpolations are string types. No tooling available for enforcing this.
- Strict un-awaited promise checking. Can use tslint and a special `spawn()` function for this.

## Build speed

- `transpileOnly` seems up to 33% faster than full typechecking on incremental rebuilds.
- Sucrase claims 20x faster, but you won’t get babel transforms like react hot loader—interesting project to watch

## Misc

- Class fields are initialized in order of: a,b,c (so b will be `undefined`):
    
    ```jsx
    class C {
      c: string;
      constructor(public a: string) {
        this.c = '';
      }
      b = this.c;
    }
    ```
    

## Declarations

**Overview**
Symbols (named types and named values) can exist locally in a module, or globally.

*.d.ts that just declare globals can exist anywhere in your source tree as long as they’re included in your tsconfig with e.g. `"``include``"``: [``"``src``"``]`, even if `isolatedModules` is set.

```
interface Stuff { ... }

```

If you’re extending something that lives in the global scope, and you’re doing so from within a module, you need to wrap in `declare global {...}`.

**By default tsc auto-includes all global files**, so just by `yarn add @types/jquery{,-plugin}` you should have both those types available from the global scope.

**Declaration Merging**
The [docs](https://www.typescriptlang.org/docs/handbook/declaration-merging.html) are good.  Some examples are straight from there.

You can merge interfaces local to your module:

```
interface A {...}
interface A {...}

```

You can also merge into (extend) interfaces declared in other modules:

```
// observable.ts stays the same
// map.ts
import { Observable } from "./observable";
declare module "./observable" {
    interface Observable<T> {
        map<U>(f: (x: T) => U): Observable<U>;
    }
}
Observable.prototype.map = function (f) {
    // ... another exercise for the reader
}

// consumer.ts
import { Observable } from "./observable";
import "./map";
let o: Observable<number>;
o.map(x => x.toFixed());

```

Or that are declared globally (JQuery exists in the global scope, not in a module):

```
// if you're inside a module file
declare global {
  interface JQuery {...}
}

// if you're inside a global file
interface JQuery {...}

```

**Declare a simple member of node** `**global**`

```
// if you're inside a module file
declare global {
  namespace NodeJS {
    interface Global { // `global` is of type Global
      initializedTests: boolean;
    }
  }porta
}

// another way: treat the `global` variable as a namespace.
declare namespace global {
  let initializedTests: boolean;
}

global.initializedTests = true;

```

**Extend a global library class—use** `**interface**`

```
declare global {
  namespace Express {
    export interface Request {
      con: Connection;
      txMgr: EntityManager;
    }
  }
}

```

**Add fields to a function**

```
function _yop(p) {
  throw new Error("yield-on-promise not supported in browser");
}
namespace _yop {
  export let frun;
}
_yop.frun = function(f) { ... };

```

**Expose some library method**

(e.g. so you can inherit the class and call super()—I think this only works if library came as .d.ts)

```
declare module "react-virtualized/dist/es/MultiGrid" {
  interface MultiGrid {
    _renderBottomRightGrid(props: any): any;
  }
}

class MyMultiGrid extends MultiGrid {
  _renderBottomRightGrid(props: any) {
    return cloneElement(super._renderBottomRightGrid(props), {
      tabIndex: null
    });
  }
}

```

# Animation

See [Animations](https://paper.dropbox.com/doc/Animations--AY9Ko6B_2PtA9npzqNDQuRTNAg-Ij0zYs2TwgBCWJ5Eyeyyf)

# Javascript

- Microtasks run before macrotasks.  Microtasks ~= promises, macrotasks ~= everything else ([source](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/), [source](https://stackoverflow.com/questions/25915634/difference-between-microtask-and-macrotask-within-an-event-loop-context))
- You can implement async using generators.  Async generators are generators of asyncs, so you can still implement them using nested generators.

# Browser Dynamism

- document.write doesn’t block but any injected scripts do block *after* the whole script that did the document.write runs ([source](https://eager.io/blog/the-curious-case-of-document-write/)):<script>
console.log('a');
document.write('<script src="printC.js"></' + 'script>');
console.log('b');
</script><script>
console.log('d');
</script>This file will log:a
b
c
d

# Events

- Mouse
    - mouseenter
        - These do not bubble; instead, different event sent to each element involved
        - Sent from outermost element to innermost (source—MDN seems wrong)
        - React has its own propagation rules, propagating from source up to lowest common ancestor then down to destination, with no capture phase (source)
        - React’s mouseenter is implemented in terms of actual DOM mouseover/mouseout!  (Determined by experimentation and source)
    - mouseover
        - Bubbles, which can generate many events/seem confusing
    - Order when moving into then out of a box: mouseover, mouseenter, mouseout, mouseleave (source)
- React propagates events by the React component tree, not by actual DOM order (matters esp. for portals)

# CSS

See also my [CSS notes](https://docs.google.com/document/d/1PFX_eQ7wcld5Uy-xvAYQZ2K3WDXKu1rs822HNxIQqoY/edit)

## Layout

- text-overflow: ellipsis only works with display:block/inline-block, not flex. ([SO](https://stackoverflow.com/a/39473383))

## Sizing

## Flexbox

- [MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Flexible_Box_Layout/Basic_Concepts_of_Flexbox)
- Spacing
    - Beyond these auto values, spacing is set by margins on individual children
        
        ![align-items.svg](Web%20development%20768a80680473459b963814b7f4a9c716/align-items.svg)
        
        ![justify-content.svg](Web%20development%20768a80680473459b963814b7f4a9c716/justify-content.svg)
        
        ![align-content.svg](Web%20development%20768a80680473459b963814b7f4a9c716/align-content.svg)
        
- Sizing
    - flex-basis is the default size of a child before spacing is distributed
    - flex-grow is how much to grow—easier to think about
    - flex-shrink is **how much to take away from any element**—e.g., you can take away 2x from certain elements than others ([MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/flex-shrink))
        
        ![image.gif](Web%20development%20768a80680473459b963814b7f4a9c716/image.gif)
        
- `margin:auto` can flush elements out ([source](https://hackernoon.com/flexbox-s-best-kept-secret-bd3d892826b6))
- No equivalent to border-spacing in tables; elements define their own surrounding spacing. Flex gap is standardized but not implemented ([source](https://github.com/w3c/csswg-drafts/issues/1696#issuecomment-486920584), [issue](https://bugs.chromium.org/p/chromium/issues/detail?id=762679))
- flex:1 only affects the ‘used’ or ‘computed’ dimensions of a div, not its specified value.  If you have a child using e.g. height:100%, that’s 100% of the specified value only, so it will ignore the height set by the div!  This affects how you nest things within a flex:1 div.  ([SO](https://stackoverflow.com/a/18866957/43118))
- flex items don't support margin collapse
- flex items don’t shrink to clip their content by default (even if you set overflow:hidden) ([source](https://stackoverflow.com/questions/36247140/why-dont-flex-items-shrink-past-content-size?noredirect=1&lq=1))
- flex doesn’t have gap/border-spacing, so instead set margin-left on items, neg padding on container ([source](https://stackoverflow.com/questions/20626685/better-way-to-set-distance-between-flexbox-items))
- `vertical-align: baseline`  aligns last lines, `align-items: baseline` lines up first lines

## Grid

- [Primer](https://developers.google.com/web/updates/2017/01/css-grid), [CSSTricks](https://css-tricks.com/snippets/css/complete-guide-grid/), [MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Grid_Layout)
- Grid sizes can be `auto` for content-sized, `3fr` for grid’s equivalent to flex units, `minmax(a,b)` for both min-width and max-width in one
- Grid cells can be `grid-column:1/3` to mean spanning columns 1 through 2
- Rows/columns can be named “zones,” and cells can position themselves to the name (to make the CSS references more maintainable, vs. index based)
- Cells can overlap
- Vs. tables ([source](https://medium.com/@js_tut/new-things-css-grid-brings-to-the-table-e465cb5d2841))
    - Similarities: spans, gaps, content-sized (`table-layout:fixed` can be hacked with a filler 100% column)
    - Differences: content alignment, multi-directional float (TODO)
- `minmax(min-content, max-content)` for content sizing
- “When fr and auto are used together, fr “wins” the fight for remaining space and auto loses its width value, shrinking down to the min-width of its element content.” ([source](https://www.rawkblog.com/2018/03/css-grid-understanding-grid-gap-and-fr-vs-auto-units/))
- TODO does baseline work with grid?

## Grid vs Flexbox

[rachelandrew/cssgrid-ama#15](https://github.com/rachelandrew/cssgrid-ama/issues/15):

> Flexbox works from the content out. I have a bunch of stuff and I want to arrange it in a row or column, let the content make most of the decisions about how much space it needs.Grid works from the layout in. I'm creating a layout, I'm then putting things into that structure. There is some ability to create tracks which respond to size of content but that is going to change the whole track.
> 
- Same: both let you wrap (dynamic set of auto-placed children).
- Same: Flexbox lets you fill up a row with as many children as will fit.  Grid also achieves this with `auto-fill` (and optionally `minmax`).
- Flexbox lets you specify `margin:auto` to flush neighbors as far away as possible.
- **Flexbox lets you have wrapped items that are purely content-sized and unaligned**. Grid lets you require all auto-placed items be aligned on rows and columns (the tracks are content-sized, set to the max of all the content on the track).
    
    ![https://paper-attachments.dropbox.com/s_FCC5DE58BC0F21F7D1B86DC1CD76A859C46697456AF74D4A544AE2B74B8033DE_1554272117002_image.png](https://paper-attachments.dropbox.com/s_FCC5DE58BC0F21F7D1B86DC1CD76A859C46697456AF74D4A544AE2B74B8033DE_1554272117002_image.png)
    
    ![https://paper-attachments.dropbox.com/s_FCC5DE58BC0F21F7D1B86DC1CD76A859C46697456AF74D4A544AE2B74B8033DE_1554272140986_image.png](https://paper-attachments.dropbox.com/s_FCC5DE58BC0F21F7D1B86DC1CD76A859C46697456AF74D4A544AE2B74B8033DE_1554272140986_image.png)
    
- Grid lets you specify gap.
- Grid lets you overlap.
- Grid feels sturdier.  “While the flexing of flexbox is sometimes its strength, the way a flex item is sized gets rather complicated. It's a combination of width, min-width, max-width, flex-basis, flex-grow, and flex-shrink, not to mention the content inside and things like white-space, as well as the other items in the same row. Grid has interesting space-occupying features, like fractional units, and the ability for content to break grids, though, generally speaking, we're setting up grid lines and placing items within them that plop right into place.”
- [Great comparison](https://css-tricks.com/quick-whats-the-difference-between-flexbox-and-grid/)
- [More](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Grid_Layout/Relationship_of_Grid_Layout#Grid_and_flexbox)

# node

- Chrome developer tools is the bomb for node apps, can attach and debug, profile, etc.
    - E.g. console, cpu profiler, heap profiler  are much nicer than Webstorm’s
    - heap profiler can do diffs
- I debugged an [EventEmitter memory leak](https://stackoverflow.com/questions/15581978/nodejs-how-to-debug-eventemitter-memory-leak-detected-11-listeners-added) by hot-modifying node’s events.js from DevTools by adding a statement logging the stack trace where the warning is issued!

## Low-level things

- Doesn’t support true fork()

# webpack

- Thanks to ES6 imports (needed for TS) requiring *live* bindings, webpack is impossible to interactively debug [[http://bit.ly/2x1vFFJ](http://bit.ly/2x1vFFJ)](http://bit.ly/2x1vFFJ)
    - Running into this when targeting ES6 from TS
- copy-webpack-plugin on large collections of files (icon fonts) was causing builds to be ultra-slow

## Broad Problems

- Source maps do not have variable name mappings, which is supposed to be a thing. ([issue](https://github.com/facebook/create-react-app/issues/1557), [issue](https://github.com/webpack/webpack/issues/8302))

## Problems

- “`__webpack_exports__` is not defined”: probably have an empty module that has no `export`?

## Performance

- Demo: gatsby ludicrous mode [https://twitter.com/gatsbyjs/status/974507205121617920](https://twitter.com/gatsbyjs/status/974507205121617920)
- Demo: vue cli 3 webpack 4 [https://twitter.com/thelarkinn/status/995463935535996928?lang=en](https://twitter.com/thelarkinn/status/995463935535996928?lang=en)
- Metro’s headline feature is sub-second incremental rebuilds
- Parcel is supposed to have better perf
- Webpack 5 intros persistent caching

# Lodash

- Destructive methods like `_(xs).remove(x)` must be called as `_.remove(xs, x)` or else you are in functional mode and operating on a copy of xs.
- `_(xs).f(x)` doesn’t return the value like `_.f(xs, x)`; there’s an implicit chain

# Chrome Devtools (Developer Tools)

- Enabled breakpoints slow down execution
- If you want to catch/handle errors thrown by some code, but still be able to treat errors in it as uncaught so that devtools, you can use this [trick from React](https://github.com/facebook/react/issues/10474) of dispatching an event to run the code—dispatchEvent calls synchronously (not pushing to the next event loop tick), and since there is no try/catch DevTools will pause, but the stack will only unwind to the boundary.  I guess browsers track such boundaries/event loop contexts—couldn’t find any other mention of this!
    - Seems like the only real time you’d want this is when you have a library/framework that is calling some user code, and you want the user to still be able to treat their errors as uncaught (even though the library must catch the error)
- Chrome debugger can't pause on Errors that are thrown with finally blocks, but Firefox can

## Open Questions

- How does the read-only evaluation work?

# Webworkers

- MessageChannel to communicate between workers

# webworker gotchas

- DevTools Networking tab does NOT show pending requests from workers

# webworker abstractions

- workerizer, workerize-loader
- [[https://github.com/andywer/threads.js](https://github.com/andywer/threads.js)](https://github.com/andywer/threads.js)
    - can’t use external dependencies (require/import)
- [[https://github.com/josdejong/workerpool](https://github.com/josdejong/workerpool)](https://github.com/josdejong/workerpool)
    - catches errors → prevents breaking on uncaught error
    - but you can always setImmediate() on your work to run it outside the default catching scope

# core services

- gitlab, datadog, sentry, google analytics

# Promises

- use native Promises to get DevTool’s uncaught exception debugger
    - This doesn’t trigger break, as expected: new Promise((resolve) => setTimeout(resolve, 500)).then(() => {throw '';}).catch(e => console.log(e))
    - This triggers break, as expected: new Promise((resolve) => setTimeout(resolve, 500)).then(() => {throw '';})
    - This triggers break, surprisingly: new Promise((resolve) => setTimeout(() => {throw '';}, 500)).catch(e => console.log(e))
    - This doesn’t trigger break: setTimeout(() => {throw 0;}, 500)
- PWA
    - UpUp is a very easy way to add a simple offline page
    - Web app manifest display standalone parameter [does not work](https://stackoverflow.com/questions/47266973/pwa-manifest-attribute-display-standalone-not-working-on-android) when [tunneling a local server](https://developers.google.com/web/tools/chrome-devtools/remote-debugging/local-server), use ngrok
- Mobile
    - Set up [remote debugging over WiFi](https://stackoverflow.com/questions/47266973/pwa-manifest-attribute-display-standalone-not-working-on-android)) with minimal USB connectivity

# jsdom

- Loading scripts with <script> tag: tried various paths/URLs, but only this worked:var scriptEl = document.createElement('script');
scriptEl.textContent = fs.readFileSync(path);
document.head.appendChild(scriptEl);

# jQuery

- .width()/.height() don’t simply get/set the CSS width/height, but get/set the *content* size regardless of the border-box style:

> Note that `.width()` will always return the content width, regardless of the value of the CSS `box-sizing` property. As of jQuery 1.8, this may require retrieving the CSS width plus `box-sizing` property and then subtracting any potential border and padding on each element when the element has `box-sizing: border-box`. To avoid this penalty, use `.css( "width" )` rather than `.width()`.
> 

# HTML5 DND

## Pros

- Supports DND with external apps
- Built-in accessibility like Escape key handling
- No need to ask everything else to stop reacting to pointer events (hover effects, etc.)
- Supports nice abort animation

## Cons

- mousemove doesn’t fire anywhere while dragging ([sandbox](https://codesandbox.io/s/hopeful-northcutt-b4d7h))
- No fine-grained control over the drag, e.g. limiting to area or axis ([article](https://javascript.info/mouse-drag-and-drop))
- No mobile support ([article](https://javascript.info/mouse-drag-and-drop))
- If you want to continuously update stuff, the `drag` event fires every couple 100s of ms, which is slow.  Others also report perf issues (not sure if referring to this): [SO](https://stackoverflow.com/questions/46186173/are-mousemove-events-disabled-while-dragging-an-element).  Haven’t verified this myself though.

## Older resources

- [https://www.quirksmode.org/blog/archives/2009/09/the_html5_drag.html](https://www.quirksmode.org/blog/archives/2009/09/the_html5_drag.html)
- [https://www.inkling.com/blog/2013/10/html5s-drag-and-drop-problem/](https://www.inkling.com/blog/2013/10/html5s-drag-and-drop-problem/)
- [https://www.html5rocks.com/en/tutorials/file/dndfiles/](https://www.html5rocks.com/en/tutorials/file/dndfiles/)

# DOM API

- getBoundingClientRect() is relative to viewport, not document - to get latter, must add window.scrollX/Y
- Globals like Element, HTMLElement, etc. are not shared among iframes (even if the iframes can access each other).  They’re different instances, so e.g. `x instanceof HTMLElement` can be false even if `x` really is an HTML element (just comparing objects from across frames).
    - Nothing prevents you from further doing `iframeDoc.body.appendChild(document.createElement(``'``div``'``))`.  The appended child actually is `instanceof HTMLElement` and not `iframeWindow.HTMLElement`.

# Yarn

## Installation

- `yarn install` does not install missing files, you must use `--force`  or maybe `--check-files` ([issue](https://github.com/yarnpkg/yarn/issues/2240))

## Upgrading packages

- Usually first try `yarn add` the package again.
- Sometimes try upgrading a cluster of packages together if they share dependencies.  E.g., `yarn add @sentry/{node,browser}` .
- Sometimes add new packages while also upgrading a cluster of packages together if they share dependencies.  E.g., when installing @sentry/integrations, run `yarn add @sentry/{node,browser,integrations}`.
- Very low confidence in the above - both being necessary and sufficient.
- But read on for complications.

## Upgrading indirect dependency versions

- Say you `yarn add @types/react @types/react-router`.
- @types/react-router depends on @types/react.  Say that when you first installed, the latest version was @types/react@16.8.0.  Since all other packages, such as @types/react-router, specify “@types/react”: “*”, you have a single @types/react that’s at 16.8.0, which serves everyone.
- It’s important to have just a single @types/react, since otherwise you have multiple differing types, and can get errors such as `React.Context<any> is not assignable to type import(``'``…/@types/react/index``'``).Context<any>`.
- Now @types/react@16.8.4 is out, and you want to upgrade to that.
- If you run `yarn add @types/react@16.8.4`, it **only upgrades your direct dependency**, and not the indirect dependencies.  You’ll now have multiple @types/react:
    - node_modules/@types/react at 16.8.4
    - node_modules/@types/react-router/node_modules/@types/react at 16.8.0
    - And also any other packages besides react-router that transitively depend on @types/react will have their own 16.8.0!
- This is an example of how yarn version management is highly stateful and depends on what you already had in your yarn.lock.  Packages are only stuck at 16.8.0 because that’s what was there.
- Solutions?
    - There’s no yarn command to update an indirect dependency ([issue](https://github.com/yarnpkg/yarn/issues/4986)).
    - You *could* run `yarn upgrade @types/react-router`, since `upgrade`  always does a “deep” upgrade ([issue](https://github.com/yarnpkg/yarn/issues/2394)), but:
        - you’d need to do this for every top-level package that indirectly depends on `@types/react`, and you may have a ton of such packages
        - you’d need to identify all packages that eventually depend on @types/react, which is non-trivial
        - upgrading these packages may not be what you want—you may just want the types upgraded.
        - Random note: this seems like it’s equivalent to `yarn remove + add`?
    - You *could* run `yarn upgrade`, which will upgrade everything, but that may not be what you want.
    - You *could* manually edit your yarn.lock to replace all the react 16.8.0 with 16.8.4—good luck.
    - You could try a tool like [https://www.npmjs.com/package/yarn-deduplicate](https://www.npmjs.com/package/yarn-deduplicate) (via [issue](https://github.com/yarnpkg/yarn/issues/3967))
    - You could add an `"``resolutions``"``: {``"``@types/react``"``:` `"``16.8.4``"``}` to your package.json, run `yarn install`, and finally remove the resolutions clause, to effectively patch up your yarn.lock.  **This seems like one good solution**.
    - **Actually, correction on the above:** You just need to run `yarn upgrade [any package that depends on @types/react:*]`, and the side effect is that *all* packages with that dependency get upgraded!  **This is the best solution, but only if there is some dependent of types/react that can be upgraded.**

## Version resolution

- Of the various reasons (declining yarn popularity, etc.), this is an annoying one:
- [https://blog.npmjs.org/post/621733939456933888/npm-v7-series-why-keep-package-lockjson.html](https://blog.npmjs.org/post/621733939456933888/npm-v7-series-why-keep-package-lockjson.html)
- [https://classic.yarnpkg.com/blog/2017/05/31/determinism/](https://classic.yarnpkg.com/blog/2017/05/31/determinism/)
- [https://github.com/yarnpkg/yarn/issues/4024#issuecomment-318059143](https://github.com/yarnpkg/yarn/issues/4024#issuecomment-318059143)
    - yarn's stance is to not try to dedupe repeated dependencies; only for peerDependencies is there an attempt to resolve to the same version.

## Links

- `yarn link` has the following problems:
    - Does not expose transitive dependencies.  E.g. if you add a dependency like copy-webpack-plugin to react-scripts, it won’t get seen by your app (even if you yarn install in the react-scripts dir).
    - Does not install bin scripts.  E.g. if you add a bin script to react-scripts (or rename one or whatever), it won’t get seen by your app.
    - Dependency can’t see what peer dependencies you have in your app.  E.g., react-scripts fails with “To import Sass files, you first need to install node-sass” error even if you already have node-sass
    - Cannot work on multiple versions of the same package (the name is already taken)
    - Can use `yalc` to work around these issues (see section)
- `yarn unlink` does not restore files, you need `install` `--``force` ([issue](https://github.com/yarnpkg/yarn/issues/1957))

## Yalc

- Use `yalc link`  to not touch package.json
- After `yalc add/update`, you may want to run `yarn install` `--``force` to actually patch things up if you added deps, changed bin scripts, etc. ([issue](https://github.com/whitecolor/yalc/issues/77))

# Create-React-App

## Gotchas

- Proxy only proxies requests that don’t accept text/html, so simply trying e.g. /api from your browser still returns the index.html

## Limitations

- Doesn’t respect .eslintignore ([issue](https://github.com/facebook/create-react-app/issues/2339))
- Babel has various limitations supporting Typescript (see [+Web Dev Tips: Babel](https://paper.dropbox.com/doc/Web-Dev-Tips-Babel-ohIiFVGa3PcjyBrm8zHew#:uid=393183792680146062083329&h2=Babel) )

# Babel

## Limitations

- `import blah = …` is not supported.  You can instead use either of:
    - If you’re importing a module, then use `import blah from 'blah'` .  See below!
    - If you’re importing a type/value, then use either `type foo = bar.foo`  or `const foo = bar.foo`
        - import DragSourceMonitor = ReactDND.DragSourceMonitor
        - For things that are simultaneously both a type and a value, such as classes and enums, then use both `type foo = bar.foo; const foo = bar.foo`

# Sucrase

## Performance

These were run around 2019-02-26.

- wab
    - full build
        - babel: 1m43s
        - sucrase: 44s
    - incremental build
        - babel: 4.5s
            - seems to be caching things, for uncached code: 7s
        - sucrase: 3.5s
- rubik
    - full build
        - sucrase with tsc: 28s
        - sucrase with no tsc: 20s
        - babel with no tsc: 42.5s
    - incremental build
        - sucrase with tsc: 23s, 19s
            - I don’t think that this is necessarily normal, may be due to the error state?
        - sucrase with no tsc: 2.5s, 2s
        - babel with no tsc: 8s, 8.5s

Webpack’s own parser/compiler may be accounting for the rest of the time.

These were run 2019-03-11:

- wab tests
    - sucrase:
        - Test Suites: 1 skipped, 35 passed, 35 of 36 total
        - Tests:       1 skipped, 340 passed, 341 total
        - Snapshots:   2 passed, 2 total
        - Time:        101.05s, estimated 104s
        - Ran all test suites.
    - babel:
        - 294s

These were run 2019-03-15.  Side lessons: stop jest watcher, wait for IDE tsc to settle:

- wab webpack incremental (style-tab.tsx):
    - 3.2s
    - no webpack-copy: 2.5s
- 
    
    ## no eslint: 3s
    

## Limitations

- No decorators (react-dnd, memoize, TypeORM, etc.)
- No JSX spread children: `{...children}`
- Misc other syntax we use throughout Rubik

# Module Systems

- CommonJS: used by node, is sync, `require/module.exports`
- AMD: supports async loading, `define/require`
- ES Modules: the new standard, is language level declaration, `import/export`
- UMD: not a module system, just a pattern of writing JS files (mainly a wrapper/scaffolding) that supports either CJS or AMD
- SystemJS: a dynamic loader that supports the above module systems

# Misc

- [https://stackoverflow.com/questions/18981909/how-to-show-a-running-progress-bar-while-page-is-loading](https://stackoverflow.com/questions/18981909/how-to-show-a-running-progress-bar-while-page-is-loading)